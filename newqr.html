<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ScanAttend | Generator</title>

  <!-- QR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Leaflet Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="qr-card">
  <img src="logo.png" class="logo">
  <h2>QR Code Generator</h2>

  <input type="text" id="qr-input" placeholder="Session Name (e.g. CS101)">

  <select id="time-limit">
    <option value="5">Expire in 5 Minutes</option>
    <option value="10">Expire in 10 Minutes</option>
    <option value="30" selected>Expire in 30 Minutes</option>
    <option value="60">1 Hour</option>
  </select>

  <!-- MAP -->
  <div id="map" style="height:300px;border-radius:10px;margin:15px 0;"></div>
  <p id="loc-status" style="font-size:12px;color:#64748b;">
    Select lecture location on map
  </p>

  <button id="gen-btn" onclick="generateQR()" disabled>Create QR Code</button>

  <div id="printable-area" style="margin-top:20px;background:#fff;padding:20px;border-radius:8px;display:inline-block;">
    <div id="session-title" style="font-weight:bold;margin-bottom:10px;"></div>
    <div id="qrcode"></div>
  </div>

  <button id="dl-btn" style="display:none;margin-top:15px;" onclick="downloadQR()">
    Download Image
  </button>

  <br>
  <a href="dashboard.html" class="back-link">Back to Dashboard</a>
</div>

<script>
/* ===============================
   LOCATION + MAP CONFIG
================================ */
let lecturerCoords = null;
let marker = null;

// Lira University bounds (LOCKED)
const LIRA_BOUNDS = [
  [2.243, 32.815], // SW
  [2.260, 32.827]  // NE
];

const map = L.map("map", {
  center: [2.251, 32.821],
  zoom: 17,
  minZoom: 16,
  maxZoom: 40,
  maxBounds: LIRA_BOUNDS,
  maxBoundsViscosity: 1.0
});

// Satellite imagery ONLY
L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  { attribution: "Satellite" }
).addTo(map);

// Select location
map.on("click", e => {
  lecturerCoords = {
    lat: e.latlng.lat,
    lng: e.latlng.lng
  };

  if (marker) marker.remove();
  marker = L.marker(e.latlng).addTo(map);

  document.getElementById("loc-status").innerText = "Location selected (Campus only)";
  document.getElementById("gen-btn").disabled = false;
});

/* ===============================
   QR GENERATION
================================ */
const qrcode = new QRCode(document.getElementById("qrcode"), {
  width: 300,
  height: 300,
  correctLevel: QRCode.CorrectLevel.M
});

function generateQR() {
  const session = document.getElementById("qr-input").value.trim();
  const minutes = document.getElementById("time-limit").value;

  if (!session) {
    alert("Enter session name");
    return;
  }

  if (!lecturerCoords) {
    alert("Select location on the map");
    return;
  }

  // FORMAT: session|timestamp|lat|lng|expiry
  const qrData =
    `${session}|${Date.now()}|${lecturerCoords.lat}|${lecturerCoords.lng}|${minutes}`;

  qrcode.clear();
  qrcode.makeCode(qrData);

  document.getElementById("session-title").innerText = session.toUpperCase();
  document.getElementById("dl-btn").style.display = "block";
}

function downloadQR() {
  const img = document.querySelector("#qrcode img");
  const link = document.createElement("a");
  link.href = img.src;
  link.download = `QR_${document.getElementById("qr-input").value}.png`;
  link.click();
}
</script>

</body>
</html>